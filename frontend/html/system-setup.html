<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CVALTIS - System Setup &amp; Admin</title>
  <link rel="stylesheet" href="../style/system-setup.css">
  <link rel="stylesheet" href="../style/system-admin.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    (function() {
      var saved = localStorage.getItem('cvaltis-theme');
      var isDark = saved === null ? true : saved === 'dark';
      document.documentElement.classList.add(isDark ? 'theme-dark' : 'theme-light');
    })();
  </script>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js"></script>
  <script src="system-setup-auth.js"></script>
  <div id="app" class="setup-wrap" :class="[isDark ? 'theme-dark' : 'theme-light', showAdmin ? 'admin-wrap' : '']">
    <!-- Circuit background: cyan lines and nodes -->
    <div class="circuit-bg" aria-hidden="true">
      <svg class="circuit-svg" viewBox="0 0 1200 900" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Nodes (glowing dots) -->
        <circle cx="200" cy="120" r="5" class="node"/>
        <circle cx="1000" cy="100" r="5" class="node"/>
        <circle cx="1050" cy="280" r="5" class="node"/>
        <circle cx="150" cy="380" r="5" class="node"/>
        <circle cx="1100" cy="450" r="5" class="node"/>
        <circle cx="80" cy="600" r="5" class="node"/>
        <circle cx="1050" cy="720" r="5" class="node"/>
        <circle cx="220" cy="800" r="5" class="node"/>
        <circle cx="600" cy="80" r="5" class="node"/>
        <circle cx="580" cy="820" r="5" class="node"/>
        <!-- Lines from card area outward -->
        <path d="M 380 200 L 200 200 L 200 120" class="line"/>
        <path d="M 820 200 L 1000 200 L 1000 100" class="line"/>
        <path d="M 820 350 L 1000 350 L 1050 280" class="line"/>
        <path d="M 380 450 L 200 450 L 150 380" class="line"/>
        <path d="M 820 500 L 1050 500 L 1100 450" class="line"/>
        <path d="M 400 650 L 150 650 L 80 600" class="line"/>
        <path d="M 800 700 L 1000 700 L 1050 720" class="line"/>
        <path d="M 400 750 L 280 750 L 220 800" class="line"/>
        <path d="M 600 250 L 600 80" class="line"/>
        <path d="M 600 650 L 600 820" class="line"/>
        <path d="M 380 320 L 280 320 L 280 380" class="line"/>
        <path d="M 820 320 L 920 320 L 920 400" class="line"/>
      </svg>
    </div>

    <!-- Dark / Light theme toggle - outside the form -->
    <div v-if="!showAdmin" class="theme-toggle-wrap theme-toggle-outside" role="switch" :aria-checked="isDark" aria-label="Light or dark mode">
      <button type="button" class="theme-toggle" @click="isDark = !isDark" :class="{ dark: isDark, light: !isDark }">
        <span class="toggle-track">
          <span class="toggle-pill"></span>
        </span>
        <span class="toggle-labels"><span class="toggle-dark">Dark</span><span class="toggle-light">Light</span></span>
      </button>
    </div>

    <main v-if="!showAdmin" class="setup-card">
      <template v-if="!setupComplete">
        <registration-form />
      </template>
      <div v-else class="setup-complete">
        <p class="setup-complete-title">{{ t.setupCompleteTitle }}</p>
        <p class="setup-complete-msg">{{ t.setupCompleteMsg }}</p>
        <button type="button" class="btn btn-next" style="margin-top:1rem;" @click="goToAdmin">{{ t.openSystemAdmin }}</button>
      </div>
    </main>

    <!-- System Admin dashboard (same file, shown after setup or when opening admin) -->
    <template v-if="showAdmin">
      <div class="theme-toggle-wrap" role="switch" :aria-checked="isDark" aria-label="Light or dark mode">
        <button type="button" class="theme-toggle" @click="isDark = !isDark" :class="{ dark: isDark, light: !isDark }">
          <span class="toggle-track"><span class="toggle-pill"></span></span>
          <span class="toggle-labels"><span class="toggle-dark">Dark</span><span class="toggle-light">Light</span></span>
        </button>
      </div>
      <aside class="admin-sidebar">
        <div class="admin-user-block">
          <div class="admin-avatar" aria-hidden="true">
            <img v-if="owner.profileDataUrl" :src="owner.profileDataUrl" alt="" class="admin-avatar-img">
            <svg v-else viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/></svg>
          </div>
          <div class="admin-user-info">
            <p class="admin-user-name">{{ owner.firstName || "User's Name" }} {{ owner.lastName }}</p>
            <p class="admin-user-role">System Administrator</p>
          </div>
        </div>
        <nav class="admin-nav">
          <button type="button" class="admin-nav-item" :class="{ active: currentSection === 'services' }" @click="currentSection = 'services'">Services</button>
          <button type="button" class="admin-nav-item" :class="{ active: currentSection === 'plugins' }" @click="currentSection = 'plugins'">Plugins</button>
          <button type="button" class="admin-nav-item" :class="{ active: currentSection === 'users' }" @click="currentSection = 'users'">Users</button>
          <button type="button" class="admin-nav-item" :class="{ active: currentSection === 'auth-keys' }" @click="currentSection = 'auth-keys'">Auth Keys</button>
          <button type="button" class="admin-nav-item" :class="{ active: currentSection === 'monitoring' }" @click="currentSection = 'monitoring'">Monitoring</button>
        </nav>
      </aside>
      <main class="admin-main">
        <p class="admin-breadcrumb">System Admin &gt; <span>{{ sectionTitle }}</span></p>
        <div class="admin-content-card">
          <h2 class="admin-page-header"><span class="admin-page-title">{{ sectionTitle }}</span></h2>
          <template v-if="currentSection === 'plugins'">
            <div class="admin-toolbar">
              <div class="admin-summary-card">
                <div class="admin-summary-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                </div>
                <div>
                  <p class="admin-summary-label">Total Plugins</p>
                  <p class="admin-summary-value">{{ filteredPlugins.length }}</p>
                </div>
              </div>
              <div class="admin-search-wrap">
                <span class="admin-search-icon" aria-hidden="true">üîç</span>
                <input type="search" class="admin-search" placeholder="Search" v-model="pluginSearch" aria-label="Search plugins">
              </div>
            </div>
            <div class="admin-table-wrap">
              <table class="admin-table">
                <thead>
                  <tr><th>Name</th><th>Version</th><th>Action</th></tr>
                </thead>
                <tbody>
                  <tr v-for="plugin in filteredPlugins" :key="plugin.id">
                    <td>{{ plugin.name }}</td>
                    <td>{{ plugin.version }}</td>
                    <td>
                      <button type="button" class="admin-toggle" :class="{ on: plugin.enabled }" @click="plugin.enabled = !plugin.enabled" :aria-label="plugin.enabled ? 'Disable' : 'Enable'">
                        <span class="admin-toggle-pill"></span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </template>
          <template v-else>
            <p class="section-label" style="margin-top:0;">Select a section from the sidebar. This view shows <strong>{{ sectionTitle }}</strong> when implemented.</p>
          </template>
        </div>
      </main>
    </template>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    (function() {
      var createApp = Vue.createApp;

      function createSetupApp() {
        return createApp({
          data: function() {
        var saved = typeof localStorage !== 'undefined' && localStorage.getItem('cvaltis-theme');
        var isDark = saved === null ? true : saved === 'dark';
        return {
          isDark: isDark,
          step: 1,
          totalSteps: 5,
          totalDots: 10,
          selectedLanguage: '',
          agency: { name: '', address: '', email: '', logoDataUrl: '' },
          owner: { lastName: '', firstName: '', middleName: '', email: '', dob: '', address: '', password: '', confirmPassword: '', profileDataUrl: '' },
          showOwnerPassword: false,
          showOwnerConfirm: false,
          emailVerified: false,
          authLoading: false,
          errorMessage: '',
          stepLabelsEn: ['Language', 'Agency / Business Information', 'System Owner Registration', 'Email Verification', 'Authenticator Setup'],
          stepLabelsTl: ['Wika', 'Impormasyon ng Ahensya / Negosyo', 'Rehistrasyon ng May-ari ng Sistema', 'Pagpapatotoo ng Email', 'Setup ng Authenticator'],
          setupKey: '',
          qrDataUrl: '',
          otpCode: '',
          showOtp: false,
          otpVerified: false,
          setupComplete: false,
          emailVerificationCode: '',
          showAdmin: false,
          currentSection: 'plugins',
          pluginSearch: '',
          plugins: [],
        };
      },
      provide: function() {
        return { setup: this };
      },
      computed: {
        lang() {
          return this.selectedLanguage === 'tl' ? 'tl' : 'en';
        },
        t() {
          const en = {
            welcome: 'Welcome to the',
            systemSubtitle: 'A Centralized Virtual Administration of Local Transaction and Integrated Services System.',
            instruction: 'Just fill in the information below to setup the system to your liking.',
            logoHolder: 'AGENCY LOGO HOLDER',
            logoHolderHint: 'Appears after uploading Logo',
            step1Title: 'Select your language',
            selectLanguagePlaceholder: 'Select language...',
            step2Intro: 'This collects the basic information of the company / agency.',
            agencyName: 'Agency / Business Name',
            agencyAddress: 'Agency / Business Address',
            agencyEmail: 'Agency / Business Email',
            agencyLogo: 'Agency / Business Logo',
            changeLogo: 'Change logo',
            step3Intro: "This collects the owner / head's information.",
            step3Sublabel: 'The appointed System Admin should assist.',
            uploadProfile: 'Upload profile',
            changePhoto: 'Change photo',
            lastName: 'Last Name',
            firstName: 'First Name',
            middleName: 'Middle Name',
            email: 'Email',
            dateOfBirth: 'Date of Birth',
            homeAddress: 'Home Address',
            password: 'Password',
            confirmPassword: 'Confirm Password',
            step4Intro: "This collects the owner / head's information.",
            emailVerifyInstruction: 'Type in the verification code we sent to',
            emailVerifiedMsg: 'Email verified. Click NEXT to continue.',
            emailVerifyCode: 'Email Verification Code',
            resendCode: 'RESEND CODE',
            verify: 'VERIFY',
            step5Intro: "This collects the owner / head's information.",
            authenticatorInstruction: 'Install an Authenticator app and use it to scan the QR code or enter the key to get a login OTP.',
            setupKey: 'Setup Key',
            enterOtp: 'Enter OTP',
            checkOtp: 'CHECK OTP',
            errorHandler: 'Error Handler message',
            previous: 'PREVIOUS',
            next: 'NEXT',
            finish: 'FINISH',
            setupCompleteTitle: 'Setup complete',
            setupCompleteMsg: 'You can now sign in with your email and password.',
            openSystemAdmin: 'Open System Admin',
            errSelectLanguage: 'Please select a language.',
            errEmailPassword: 'Email and password are required.',
            errPasswordLength: 'Password must be at least 6 characters.',
            errPasswordMatch: 'Passwords do not match.',
            errEnterCode: 'Please enter the 6-digit code.',
            errValidOtp: 'Please enter a valid 6-digit OTP.',
            errSetupKey: 'Setup key not ready. Refresh and try again.',
            errInvalidOtp: 'Invalid OTP. Try again.',
            yourEmail: 'your email',
          };
          const tl = {
            welcome: 'Maligayang pagdating sa',
            systemSubtitle: 'Isang Sentralisadong Virtual na Administrasyon ng Lokal na Transaksyon at Pinagsamang Serbisyong Sistema.',
            instruction: 'Punan lamang ang impormasyon sa ibaba para ma-setup ang sistema ayon sa iyong kagustuhan.',
            logoHolder: 'LALAGYAN NG LOGO NG AHENSYA',
            logoHolderHint: 'Lalabas pag na-upload ang logo',
            step1Title: 'Pumili ng iyong wika',
            selectLanguagePlaceholder: 'Pumili ng wika...',
            step2Intro: 'Kinokolekta nito ang pangunahing impormasyon ng kumpanya / ahensya.',
            agencyName: 'Pangalan ng Ahensya / Negosyo',
            agencyAddress: 'Adres ng Ahensya / Negosyo',
            agencyEmail: 'Email ng Ahensya / Negosyo',
            agencyLogo: 'Logo ng Ahensya / Negosyo',
            changeLogo: 'Palitan ang logo',
            step3Intro: 'Kinokolekta nito ang impormasyon ng may-ari / pinuno.',
            step3Sublabel: 'Dapat tumulong ang itinalagang System Admin.',
            uploadProfile: 'Mag-upload ng profile',
            changePhoto: 'Palitan ang larawan',
            lastName: 'Apelyido',
            firstName: 'Pangalan',
            middleName: 'Gitnang Pangalan',
            email: 'Email',
            dateOfBirth: 'Petsa ng Kapanganakan',
            homeAddress: 'Tirahan',
            password: 'Password',
            confirmPassword: 'Kumpirmahin ang Password',
            step4Intro: 'Kinokolekta nito ang impormasyon ng may-ari / pinuno.',
            emailVerifyInstruction: 'I-type ang verification code na ipinadala namin sa',
            emailVerifiedMsg: 'Na-verify na ang email. I-click ang SUSUNOD para magpatuloy.',
            emailVerifyCode: 'Verification Code ng Email',
            resendCode: 'IPADALA MULI ANG CODE',
            verify: 'IVERIFY',
            step5Intro: 'Kinokolekta nito ang impormasyon ng may-ari / pinuno.',
            authenticatorInstruction: 'Mag-install ng Authenticator app at gamitin ito para i-scan ang QR code o ilagay ang key para makakuha ng login OTP.',
            setupKey: 'Setup Key',
            enterOtp: 'Ilagay ang OTP',
            checkOtp: 'SURIIN ANG OTP',
            errorHandler: 'Mensahe ng Error Handler',
            previous: 'NAUNA',
            next: 'SUSUNOD',
            finish: 'TAPOS',
            setupCompleteTitle: 'Kumpleto na ang setup',
            setupCompleteMsg: 'Maaari ka nang mag-sign in gamit ang iyong email at password.',
            openSystemAdmin: 'Buksan ang System Admin',
            errSelectLanguage: 'Pumili ng wika.',
            errEmailPassword: 'Kailangan ang email at password.',
            errPasswordLength: 'Ang password ay dapat hindi bababa sa 6 na character.',
            errPasswordMatch: 'Hindi magkapareho ang mga password.',
            errEnterCode: 'Ilagay ang 6-digit na code.',
            errValidOtp: 'Ilagay ang wastong 6-digit na OTP.',
            errSetupKey: 'Hindi pa handa ang setup key. I-refresh at subukan muli.',
            errInvalidOtp: 'Hindi wasto ang OTP. Subukan muli.',
            yourEmail: 'iyong email',
          };
          return this.lang === 'tl' ? tl : en;
        },
        stepLabels() {
          return this.lang === 'tl' ? this.stepLabelsTl : this.stepLabelsEn;
        },
        sectionTitle() {
          const titles = this.lang === 'tl'
            ? { services: 'Mga Serbisyo', plugins: 'Mga Plugin', users: 'Mga User', 'auth-keys': 'Auth Keys', monitoring: 'Monitoring' }
            : { services: 'Services', plugins: 'Plugins', users: 'Users', 'auth-keys': 'Auth Keys', monitoring: 'Monitoring' };
          return titles[this.currentSection] || (this.lang === 'tl' ? 'System Admin' : 'System Admin');
        },
        filteredPlugins() {
          const q = (this.pluginSearch || '').toLowerCase().trim();
          if (!q) return this.plugins;
          return this.plugins.filter(p => p.name.toLowerCase().includes(q) || p.version.toLowerCase().includes(q));
        },
      },
      mounted() {
        this.step = 1;
        this.syncTheme();
      },
      watch: {
        isDark() {
          this.syncTheme();
        },
        step(n) {
          if (n === 5 && !this.setupKey && window.SystemSetupAuth && window.QRCode) {
            this.setupKey = window.SystemSetupAuth.generateSecret();
            const issuer = 'CVALTIS';
            const account = this.owner.email || 'user';
            const url = 'otpauth://totp/' + encodeURIComponent(issuer) + ':' + encodeURIComponent(account) + '?secret=' + this.setupKey + '&issuer=' + encodeURIComponent(issuer);
            window.QRCode.toDataURL(url, { width: 140, margin: 1 }).then(u => { this.qrDataUrl = u; }).catch(() => {});
          }
        },
      },
      methods: {
        nextStep() {
          if (this.step === 1 && !this.selectedLanguage) {
            this.errorMessage = this.t.errSelectLanguage;
            return;
          }
          if (this.step === 3) {
            const ok = this.submitOwnerRegistration();
            if (!ok) return;
          }
          this.errorMessage = '';
          if (this.step < this.totalSteps) this.step++;
          else {
            this.finishSetup();
          }
        },
        prevStep() {
          this.errorMessage = '';
          if (this.step > 1) this.step--;
        },
        submitOwnerRegistration() {
          const { owner } = this;
          if (!owner.email || !owner.password) {
            this.errorMessage = this.t.errEmailPassword;
            return false;
          }
          if (owner.password.length < 6) {
            this.errorMessage = this.t.errPasswordLength;
            return false;
          }
          if (owner.password !== owner.confirmPassword) {
            this.errorMessage = this.t.errPasswordMatch;
            return false;
          }
          this.errorMessage = '';
          return true;
        },
        resendCode() {
          this.errorMessage = '';
        },
        verifyEmail() {
          const code = String(this.emailVerificationCode || '').trim();
          if (!code || code.length < 6) {
            this.errorMessage = this.t.errEnterCode;
            return;
          }
          this.errorMessage = '';
          this.emailVerified = true;
        },
        async checkOtp() {
          const code = String(this.otpCode || '').trim();
          if (code.length !== 6) {
            this.errorMessage = this.t.errValidOtp;
            return;
          }
          if (!this.setupKey || !window.SystemSetupAuth) {
            this.errorMessage = this.t.errSetupKey;
            return;
          }
          const valid = await window.SystemSetupAuth.verifyTOTP(this.setupKey, code);
          if (!valid) {
            this.errorMessage = this.t.errInvalidOtp;
            return;
          }
          this.errorMessage = '';
          this.otpVerified = true;
        },
        finishSetup() {
          this.setupComplete = true;
        },
        goToAdmin() {
          this.showAdmin = true;
        },
        syncTheme() {
          var root = document.documentElement;
          root.classList.remove('theme-dark', 'theme-light');
          root.classList.add(this.isDark ? 'theme-dark' : 'theme-light');
          try { localStorage.setItem('cvaltis-theme', this.isDark ? 'dark' : 'light'); } catch (e) {}
        },
        buttonClick(e) {
          e.currentTarget.style.transform = 'scale(0.95)';
        },
        buttonRelease(e) {
          e.currentTarget.style.transform = '';
        },
        onAgencyLogoChange(e) {
          const file = e.target.files && e.target.files[0];
          if (!file || !file.type.startsWith('image/')) return;
          const reader = new FileReader();
          reader.onload = (ev) => { this.agency.logoDataUrl = ev.target.result; };
          reader.readAsDataURL(file);
          e.target.value = '';
        },
        onOwnerProfileChange(e) {
          const file = e.target.files && e.target.files[0];
          if (!file || !file.type.startsWith('image/')) return;
          const reader = new FileReader();
          reader.onload = (ev) => { this.owner.profileDataUrl = ev.target.result; };
          reader.readAsDataURL(file);
          e.target.value = '';
        },
      },
        });
      }

      fetch('registration-form-template.html')
        .then(function(r) { return r.text(); })
        .then(function(registrationFormTemplate) {
          var app = createSetupApp();
          app.component('RegistrationForm', {
            template: registrationFormTemplate,
            inject: ['setup']
          });
          app.mount('#app');
        })
        .catch(function() {
          var appEl = document.getElementById('app');
          if (appEl) appEl.innerHTML = '<main class="setup-card"><p>Failed to load registration form. Refresh the page.</p></main>';
        });
    })();
  </script>
</body>
</html>
